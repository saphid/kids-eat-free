name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      data_repo:
        description: 'Optional: Data repository URL to fetch data from (e.g., https://github.com/user/data-repo)'
        required: false
        type: string
      data_branch:
        description: 'Branch of the data repository to use'
        required: false
        default: 'main'
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync data from external repository
        if: ${{ inputs.data_repo != '' }}
        run: |
          echo "Fetching data from external repository: ${{ inputs.data_repo }}"
          # Remove existing data folder
          rm -rf data
          # Clone only the data we need
          git clone --depth 1 --branch ${{ inputs.data_branch || 'main' }} ${{ inputs.data_repo }} temp-data
          # Move data to the expected location
          mv temp-data/data data || mv temp-data data
          rm -rf temp-data
          echo "Data synced successfully"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Validate JSON data
        run: bun run validate-data

      - name: Build Next.js site
        run: bun run build
        env:
          NEXT_PUBLIC_BASE_PATH: /kids-eat-free

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
